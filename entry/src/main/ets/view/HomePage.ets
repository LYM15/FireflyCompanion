import mainViewModel from '../mock/MainViewModel';
import CommonConstants from '../constants/CommonConstants';
import StyleConstants from '../constants/StyleConstants';
import CommonUtils from '../utils/CommonUtils';
import { mockHospital } from '../mock/publicHospital'
import type { HospitalItem } from '../mock/publicHospital'

import { equityList} from '../mock/packageList'
import type { EquityType} from '../mock/packageList'

import { CommonHeader } from '../components/CommonHeader'
import { router } from '@kit.ArkUI';


@Entry
@Component
export default struct HomePage {
  @StorageProp('currentDeviceSize') currentDeviceSize: string = CommonConstants.SM;

  build() {
    Scroll() {
      Column() {
        CommonHeader({title:$r('app.string.home_title')})
        TopSearch().margin({bottom:10})
        SwiperView().margin({bottom:10})
        CenterGridView()

        // åŒ»é™¢åˆ—è¡¨
        ListView()
      }
      .width(StyleConstants.FULL_PARENT)
      .backgroundColor($r('app.color.background'))
    }
    .scrollBar(BarState.Off)
  }
}



@Preview
@Component
struct TopSearch {
  @StorageProp('currentDeviceSize') currentDeviceSize: string = CommonConstants.SM;

  build() {
    Row() {
      Row(){
        Image($r('app.media.icon_address'))
          .height(16)
          .fillColor($r('app.color.font_primary'))
          .margin({right:6})
        Text('ä¸­éƒ¨åœ°åŒº').fontSize($r('app.float.body_text')).fontColor($r('app.color.font_primary'))

        Image($r('app.media.icon_arrow_down'))
          .height(16)
          .fillColor($r('app.color.font_primary'))
          .margin({left:3,right:6})
      }.alignItems(VerticalAlign.Center).margin({right:10})
      Row(){
        Row() {
          Image($r('app.media.icon_search'))
            .height(16)
            .fillColor($r('app.color.placeholder_color'))
            .margin({right:6})
          Text('æœç´¢')
            .fontSize($r('app.float.body_text'))
            .fontColor($r('app.color.placeholder_color'))
        }
        .height(32)
        .borderRadius(16)
        .backgroundColor($r('app.color.gray_2'))
        .padding({ left: 10 })
        .flexGrow(1)
      }.flexGrow(1)
    }
    .width('100%')
    .padding({left:20,right:20,top:10,bottom:0})
  }
}


@Preview
@Component
struct SwiperView {
  @StorageProp('currentDeviceSize') currentDeviceSize: string = CommonConstants.SM;

  // å®šä¹‰è½®æ’­å›¾å›¾ç‰‡æ•°ç»„
  private swiperImages: Resource[] = [
    $r('app.media.hospital_11'), // ç¬¬ä¸€å¼ è½®æ’­å›¾
    $r('app.media.hospital_22'), // ç¬¬äºŒå¼ è½®æ’­å›¾
    $r('app.media.hospital_33')  // ç¬¬ä¸‰å¼ è½®æ’­å›¾
  ];

  build() {
    Column() {
      Text("äº†è§£é™ªè¯Š")
        .fontSize($r('app.float.body_text'))
        .fontWeight(FontWeight.Medium)
        .alignSelf(ItemAlign.Start)
        .margin({
          left: $r('app.float.common_margin'),
          top: $r('app.float.common_margin')
        })
      Swiper() {
        ForEach(this.swiperImages, (item: Resource) => {
          Image(item)
            .borderRadius($r('app.float.card_radius'))
            .syncLoad(true)
        }, (item: Resource) => JSON.stringify(item))
      }
      .displayCount(CommonConstants.SWIPER_CACHE_COUNT)
      .autoPlay(true)
      .width(StyleConstants.COMMON_WIDTH)
      .itemSpace(this.currentDeviceSize === CommonConstants.SM ?
        0 : StyleConstants.ITEM_SPACE)
      .margin($r('app.float.common_margin'))
      .displayCount(this.currentDeviceSize === CommonConstants.SM ?
      StyleConstants.SWIPER_COUNT_ONE :
        (this.currentDeviceSize === CommonConstants.MD ?
        StyleConstants.SWIPER_COUNT_TWO : StyleConstants.SWIPER_COUNT_THREE))
    }.backgroundColor($r('app.color.color_white')).margin({left:16,right:16}).borderRadius($r('app.float.card_radius'))
  }
}


@Component
struct GridItemView {
  @Prop item: EquityType;
  private gridItemImg?: string | Resource;
  private gridItemTitle?: string | Resource;
  private gridItemPrompt?: string | Resource;

  aboutToAppear() {
    if (this.item !== undefined) {
      this.gridItemImg = this.item.pic;
      this.gridItemTitle = this.item.name;
      this.gridItemPrompt = this.item.content;
    }
  }

  build() {
    Column() {
      if(this.gridItemImg) {
        Image(this.gridItemImg)
          .width($r('app.float.home_cell_size'))
          .height($r('app.float.home_cell_size'))
          .syncLoad(true)
      }
      if (this.gridItemTitle) {
        Text(this.gridItemTitle)
          .fontSize($r('app.float.body_text'))
          .margin({ top: $r('app.float.home_cell_margin') })
      }
    }
    .onClick(() => {
      if(!this.gridItemPrompt) {
        return;
      }
      CommonUtils.showToastContent(this.gridItemPrompt);
      router.pushUrl({
        url: 'pages/CreateOrderPage',
        params: {
          orderType: this.item.name,
        }
      })
    })
  }
}


@Preview
@Component
struct CenterGridView {
  build() {
    Column() {
      Grid() {
        ForEach(equityList, (item: EquityType) => {
          GridItem() {
            GridItemView({ item: item })
          }.onClick(()=>{
            router.pushUrl({
              url: 'pages/CreateOrderPage',
              params: {
                orderType: item.name,
              }
            })
          })
        }, (item: EquityType) => JSON.stringify(item._id))
      }
      .columnsTemplate(StyleConstants.GRID_COLUMNS)
      .rowsTemplate(StyleConstants.GRID_ROWS)
      .columnsGap($r('app.float.grid_column_gap'))
      .rowsGap($r('app.float.grid_row_gap'))
      .height(StyleConstants.HOME_GRID_HEIGHT)
      .backgroundColor($r('app.color.color_white'))
      .borderRadius($r('app.float.card_radius'))
      .padding({
        top: $r('app.float.home_grid_padding'),
        bottom: $r('app.float.home_grid_padding')
      })
      .width(StyleConstants.COMMON_WIDTH)
      .margin($r('app.float.common_margin'))
    }
  }
}

@Preview
@Component
struct ListView {
  @StorageProp('currentDeviceSize') currentDeviceSize: string = CommonConstants.SM;

  build() {
    Column() {
      Text("åŒ»é™¢åˆ—è¡¨")
        .fontSize($r('app.float.body_text'))
        .fontWeight(FontWeight.Medium)
        .alignSelf(ItemAlign.Start)
        .margin({
          left: $r('app.float.common_margin'),
          top: $r('app.float.common_margin')
        })

      List({ space: StyleConstants.IMAGE_LIST_SPACE }) {
        ForEach(mockHospital, (hospitalItem: HospitalItem) => {
          ListItem() {
            ItemView({ hospitalItem: hospitalItem })
          }
          .margin({ right: $r('app.float.list_margin'), bottom: $r('app.float.list_margin') })
          .borderRadius($r('app.float.card_radius'))
          .backgroundColor($r('app.color.color_white'))
          .shadow({
            offsetX: 0,
            offsetY: 1,
            radius: 3,
            color: '#20000000'
          })
          .onClick(() => {
            CommonUtils.showToastContent(hospitalItem.name);
            // è·³è½¬åˆ°åˆ›å»ºè®¢å•é¡µé¢ï¼Œä¼ é€’åŒ»é™¢ä¿¡æ¯
            router.pushUrl({
              url: 'pages/CreateOrderPage',
              params: {
                hospitalName: hospitalItem.name,
                hospitalId: hospitalItem._id
              }
            })
          })
        }, (hospitalItem: HospitalItem) => JSON.stringify(hospitalItem._id))
      }
      .width(StyleConstants.COMMON_WIDTH)
      .margin($r('app.float.common_margin'))
      .lanes(this.currentDeviceSize === CommonConstants.SM ?
      StyleConstants.LIST_COLUMN_ONE :
        (this.currentDeviceSize === CommonConstants.MD ?
        StyleConstants.LIST_COLUMN_TWO : StyleConstants.LIST_COLUMN_THREE))
    }.backgroundColor($r('app.color.color_white')).margin({left:16,right:16}).borderRadius($r('app.float.card_radius'))
  }
}

@Component
struct ItemView {
  @Prop hospitalItem: HospitalItem;
  @State private imageLoaded: boolean = false;
  @State private imageError: boolean = false;

  // è·å–åŒ»é™¢å¯¹åº”çš„å›¾ç‰‡èµ„æº - æ ¹æ®åŒ»é™¢ç¼–å·åˆ†é…ä¸åŒçš„å›¾ç‰‡
  private getHospitalImage(): Resource {
    // æ ¹æ®åŒ»é™¢ç¼–å·åˆ†é…ä¸åŒçš„å›¾ç‰‡èµ„æº
    const hospitalNumber = this.hospitalItem.number;

    console.log(`åˆ†é…å›¾ç‰‡: åŒ»é™¢ç¼–å· ${hospitalNumber} - ${this.hospitalItem.name}`);

    switch (hospitalNumber) {
      case 4321: // æ­¦æ±‰å¤§å­¦äººæ°‘åŒ»é™¢ - ä½¿ç”¨ hospital_1
        return $r('app.media.hospital_1');
      case 4322: // åä¸­ç§‘æŠ€å¤§å­¦åŒæµåŒ»å­¦é™¢é™„å±åå’ŒåŒ»é™¢ - ä½¿ç”¨ hospital_2
        return $r('app.media.hospital_2');
      case 4323: // æ­¦æ±‰å¤§å­¦ä¸­å—åŒ»é™¢ - ä½¿ç”¨ hospital_3
        return $r('app.media.hospital_3');
      case 4324: // æ­¦æ±‰å¸‚ä¸­å¿ƒåŒ»é™¢ - ä½¿ç”¨ hospital_4
        return $r('app.media.hospital_4');
      case 4325: // æ­¦æ±‰å¸‚å¦‡å¥³å„¿ç«¥åŒ»ç–—ä¿å¥ä¸­å¿ƒ - ä½¿ç”¨ hospital_5
        return $r('app.media.hospital_5');
      case 4328: // æ­¦æ±‰åœ°åŒº-å…¶ä»–åŒ»é™¢ - ä½¿ç”¨ hospital_6
        return $r('app.media.hospital_6');
      default:  // é»˜è®¤ä½¿ç”¨ hospital_1
        console.warn(`æœªçŸ¥åŒ»é™¢ç¼–å· ${hospitalNumber}, ä½¿ç”¨é»˜è®¤å›¾ç‰‡`);
        return $r('app.media.hospital_1');
    }
  }

  aboutToAppear() {
    // åœ¨ç»„ä»¶å‡ºç°æ—¶æ‰“å°è°ƒè¯•ä¿¡æ¯
    console.log('=== åŒ»é™¢ä¿¡æ¯è¯¦æƒ… ===');
    console.log('åŒ»é™¢åç§°:', this.hospitalItem.name);
    console.log('åŒ»é™¢ç¼–å·:', this.hospitalItem.number);
    console.log('åŒ»é™¢ID:', this.hospitalItem._id);
    console.log('åˆ†é…å›¾ç‰‡æ–¹æ³•:', this.getHospitalImage());
    console.log('===================');
  }

  build() {
    Row(){
      // å›¾ç‰‡åŒºåŸŸ - ä½¿ç”¨æœ¬åœ°å›¾ç‰‡èµ„æº
      Stack() {
        // åŒ»é™¢å›¾ç‰‡ - ä½¿ç”¨å¯¹åº”çš„æœ¬åœ°å›¾ç‰‡
        Image(this.getHospitalImage())
          .width('100%')
          .height('100%')
          .backgroundColor($r('app.color.gray_1'))  // åŠ è½½æ—¶çš„èƒŒæ™¯è‰²
          .borderRadius(8)   // åœ†è§’
          .objectFit(ImageFit.Cover)  // å…³é”®ï¼šä¿æŒæ¯”ä¾‹å¡«å……
          .syncLoad(true)
          .onAppear(() => {
            this.imageLoaded = true;
            // è°ƒè¯•ä¿¡æ¯
            console.log('åŠ è½½åŒ»é™¢å›¾ç‰‡:', this.hospitalItem.name, 'ç¼–å·:', this.hospitalItem.number);
          })
          .onError(() => {
            this.imageError = true;
            console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', this.hospitalItem.name, 'ç¼–å·:', this.hospitalItem.number);
          })

        // åŠ è½½æŒ‡ç¤ºå™¨
        if (!this.imageLoaded && !this.imageError) {
          // ä½¿ç”¨LoadingProgressæ›¿ä»£Progress
          LoadingProgress()
            .width(20)
            .height(20)
            .color($r('app.color.primary_color'))
        }

        // åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºå ä½
        if (this.imageError) {
          Column() {
            Text("ğŸ¥")
              .fontSize(24)
            Text('å›¾ç‰‡åŠ è½½ä¸­')
              .fontSize(10)
              .fontColor($r('app.color.gray_6'))
              .margin({ top: 4 })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor($r('app.color.gray_1'))
          .borderRadius(8)
        }

        // åŒ»é™¢ç­‰çº§å¾½ç« ï¼ˆå¯é€‰ï¼‰
        if (this.hospitalItem.rank) {
          Column() {
            Text(this.hospitalItem.rank)
              .fontSize(10)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .padding({ left: 4, right: 4, top: 2, bottom: 2 })
          }
          .backgroundColor($r('app.color.primary_color'))
          .borderRadius({ topLeft: 0, topRight: 4, bottomLeft: 0, bottomRight: 4 })
          .position({ x: 0, y: 0 })
        }
      }
      .width(110)    // å›¾ç‰‡å®¹å™¨å®½åº¦
      .height(90)    // å›¾ç‰‡å®¹å™¨é«˜åº¦
      .borderRadius(8)
      .clip(true)    // è£å‰ªè¶…å‡ºéƒ¨åˆ†

      // æ–‡å­—ä¿¡æ¯åŒºåŸŸ
      Column() {
        Text(this.hospitalItem.name)
          .fontSize($r('app.float.subtitle_text'))
          .fontWeight(FontWeight.Bold)
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 6 })
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Row() {
          // åŒ»é™¢ç­‰çº§æ ‡ç­¾
          Column() {
            Text(this.hospitalItem.rank)
              .fontSize($r('app.float.body_text_s'))
              .fontWeight(FontWeight.Medium)
              .fontColor(Color.White)
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          }
          .backgroundColor($r('app.color.primary_color'))
          .borderRadius(12)

          // åŒ»é™¢ç±»å‹
          Text(this.hospitalItem.type)
            .fontSize($r('app.float.body_text_s'))
            .fontColor($r('app.color.gray_8'))
            .margin({ left: 8 })
        }
        .alignItems(VerticalAlign.Center)
        .margin({ bottom: 8 })

        // åœ°å€ä¿¡æ¯
        Row() {
          Text('åœ°å€ï¼š')
            .fontSize($r('app.float.body_text_s'))
            .fontColor($r('app.color.gray_6'))
          Text(this.hospitalItem.address)
            .fontSize($r('app.float.body_text_s'))
            .fontColor($r('app.color.gray_6'))
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .alignItems(VerticalAlign.Top)
        .width('100%')
      }
      .layoutWeight(1)
      .margin({ left: 12 })
      .padding({ top: 4, bottom: 4 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .height(100)
    .alignItems(VerticalAlign.Center)
    .padding({ left: 12, right: 12, top: 8, bottom: 8 })
  }
}





